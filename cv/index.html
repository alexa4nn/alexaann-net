<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alexa ann, cv</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <video id="bg-video" autoplay muted playsinline>
        <source src="../media/trees_light.mov" type="video/mp4">
    </video>
    <div class="glass-overlay"></div>
    <main>
        <a href="/" class="back-link">❧ back</a>
        <h1>cv</h1>
        <p class="cv-ornament">✢</p>
        <!-- Add your CV content here -->
        <section id="cv-sections" class="cv-sections"></section>
    </main>
    <script>
        const video = document.getElementById('bg-video');
        const MAX_T = 8; // bounce point (seconds)
        const SPEED = 0.35; // seconds per second
        let dir = 1; // 1 = forward, -1 = backward
        let last;
        let scrollTimeout;
        let mouseMoveTimeout;
        let isVideoPausedByScroll = false;
        let isVideoPausedByMouse = false;

        function step(ts) {
            if (!last) last = ts;
            const dt = (ts - last) / 1000; // seconds since last frame
            last = ts;

            if (!isNaN(video.duration) && !isVideoPausedByScroll && !isVideoPausedByMouse) {
                video.currentTime = Math.max(0, Math.min(MAX_T, video.currentTime + dir * SPEED * dt));
                if (dir === 1 && video.currentTime >= MAX_T) dir = -1;
                else if (dir === -1 && video.currentTime <= 0) dir = 1;
            }
            requestAnimationFrame(step);
        }

        video.addEventListener('loadedmetadata', () => {
            video.currentTime = 0;
            requestAnimationFrame(step);
        });
        
        function pauseVideo() {
            if (!isVideoPausedByScroll && !isVideoPausedByMouse) {
                video.pause();
            }
        }
        
        function resumeVideo() {
            if (!isVideoPausedByScroll && !isVideoPausedByMouse) {
                video.play();
                last = null; // Reset timing for smooth resume
            }
        }
        
        // Pause video on scroll, resume after 8 seconds of no scrolling
        window.addEventListener('scroll', () => {
            if (!isVideoPausedByScroll) {
                pauseVideo();
                isVideoPausedByScroll = true;
            }
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                isVideoPausedByScroll = false;
                resumeVideo();
            }, 8000);
        });
        
        // Pause video on mouse move (desktop only), resume after 8 seconds of no movement
        if (window.matchMedia('(min-width: 721px)').matches) {
            window.addEventListener('mousemove', () => {
                if (!isVideoPausedByMouse) {
                    pauseVideo();
                    isVideoPausedByMouse = true;
                }
                
                clearTimeout(mouseMoveTimeout);
                mouseMoveTimeout = setTimeout(() => {
                    isVideoPausedByMouse = false;
                    resumeVideo();
                }, 8000);
            });
        }
    </script>
    <script>
      (function(){
        var DATA_URL = '../data/cv.json'; // this page lives in /cv/, so go up one
        function esc(s){ return String(s == null ? '' : s)
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        
        // Fix em dashes and apostrophes that might show as ? due to encoding issues
        function fixDashes(s){ 
          if (!s) return s;
          return String(s)
            .replace(/(\d{4})-(\d{4})/g, '$1–$2')  // Convert year ranges with hyphen to en dash
            .replace(/(\d{4})\?(\d{4})/g, '$1–$2') // Convert year ranges with ? to en dash
            .replace(/I\?d/g, "I'd")               // Fix apostrophes in contractions
            .replace(/\?s\b/g, "'s");              // Fix possessives
        }
      
        function isSectionHeader(r){
          return r.section && !r.situation && !r.activity && !r.date && !r.location;
        }
      
        fetch(DATA_URL).then(function(r){
          if(!r.ok) throw new Error('HTTP '+r.status);
          return r.json();
        }).then(function(rows){
          // support {entries:[...]} or top-level array
          if (!Array.isArray(rows) && rows && Array.isArray(rows.entries)) rows = rows.entries;
          if (!Array.isArray(rows) || !rows.length) {
            document.getElementById('cv-sections').innerHTML = '<p>(no entries yet)</p>';
            return;
          }
      
          // group by sections using the heading rows
          var groups = [];
          var current = { title: '', items: [] }; // default group for items before first header
          for (var i=0; i<rows.length; i++){
            var r = rows[i] || {};
            if (isSectionHeader(r)) {
              if (current.items.length || current.title) groups.push(current);
              current = { title: fixDashes((r.section || '').trim()), items: [] };
            } else if (r.situation || r.activity || r.date || r.location) {
              current.items.push({
                situation: fixDashes(r.situation || ''),
                activity : fixDashes(r.activity  || ''),
                date     : fixDashes(r.date      || ''),
                location : fixDashes(r.location  || '')
              });
            }
          }
          if (current.items.length || current.title) groups.push(current);
      
          // build DOM
          var wrap = document.getElementById('cv-sections');
          var html = groups.map(function(g){
            if (!g.items.length) return '';
            var rowsHTML = g.items.map(function(it){
              return '' +
                '<div class="cv-item">' +
                  '<div class="cv-date">'      + esc(it.date)      + '</div>' +
                  '<div class="cv-situation">' + esc(it.situation) + '</div>' +
                  '<div class="cv-activity">'  + esc(it.activity)  + '</div>' +
                  '<div class="cv-location">'  + esc(it.location)  + '</div>' +
                '</div>';
            }).join('');
            var titleHTML = g.title ? '<h2 class="cv-group-title">' + esc(g.title) + '</h2>' : '';
            return '<section class="cv-group">' + titleHTML + rowsHTML + '</section>';
          }).join('');
      
          wrap.innerHTML = html || '<p>(no entries yet)</p>';
        }).catch(function(err){
          console.error('cv load error:', err);
          document.getElementById('cv-sections').innerHTML = '<p>(could not load cv)</p>';
        });
      })();
      </script>      
</body>
</html>